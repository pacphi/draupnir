name: "Test & Lint"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_race_detector:
        description: "Run tests with race detector"
        required: false
        default: true
        type: boolean

concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

env:
  MAX_BINARY_SIZE_MB: 20

jobs:
  go-version:
    name: Detect Go Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
      - name: Extract Go version
        id: version
        run: |
          go_version=$(grep '^go ' go.mod | awk '{print $2}')
          echo "version=${go_version}" >> "$GITHUB_OUTPUT"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: go-version
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go-version.outputs.version }}
          cache: true
          cache-dependency-path: go.sum
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: go-version
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go-version.outputs.version }}
          cache: true
          cache-dependency-path: go.sum
      - name: Run unit tests
        run: go test -v -count=1 -timeout=5m ./...
      - name: Run unit tests with race detector
        if: github.event.inputs.run_race_detector != 'false'
        run: go test -v -race -count=1 -timeout=5m ./...
      - name: Generate coverage
        run: |
          go test -coverprofile=coverage.out -covermode=atomic -timeout=5m ./...
          go tool cover -func=coverage.out | tail -1
      - name: Upload coverage
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.out
          retention-days: 7

  cross-compile:
    name: Cross-compile ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ubuntu-latest
    needs: go-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ needs.go-version.outputs.version }}
          cache: true
          cache-dependency-path: go.sum
      - name: Cross-compile
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "0"
        run: |
          go build -trimpath -ldflags="-s -w" \
            -o draupnir-${{ matrix.goos }}-${{ matrix.goarch }} \
            ./cmd/agent
          ls -lh draupnir-${{ matrix.goos }}-${{ matrix.goarch }}
      - name: Check binary size
        run: |
          binary="draupnir-${{ matrix.goos }}-${{ matrix.goarch }}"
          size_bytes=$(stat -c%s "$binary")
          size_mb=$(echo "scale=2; ${size_bytes} / 1048576" | bc)
          echo "Binary size: ${size_mb} MB (limit: ${{ env.MAX_BINARY_SIZE_MB }} MB)"
          if (( $(echo "${size_mb} > ${{ env.MAX_BINARY_SIZE_MB }}" | bc -l) )); then
            echo "::error::Binary exceeds size limit"
            exit 1
          fi
